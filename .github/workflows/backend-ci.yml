name: Backend CI/CD

on:
  push:
    branches: [ main, master ]
    paths:
      - 'cmd/**'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'cmd/**'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
      - '.github/workflows/backend-ci.yml'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.25'
        
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: Install dependencies
      run: go mod download
      
    - name: Run tests
      run: go test -v ./cmd/api
      
    - name: Run tests with coverage
      run: go test -v -coverprofile=coverage.out ./cmd/api
      
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: backend
        name: backend-coverage

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      run: |
        docker build -t sense-backend:latest .
        
    - name: Test Docker image
      run: |
        docker run -d --name test-container -p 8080:8080 sense-backend:latest
        sleep 10
        
        # Test health endpoint
        curl -f http://localhost:8080/health || exit 1
        
        # Cleanup
        docker stop test-container
        docker rm test-container

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build and run container
      run: |
        docker build -t sense-backend:test .
        docker run -d --name integration-test -p 8080:8080 sense-backend:test
        sleep 5
        
    - name: Test health endpoint
      run: |
        # Wait for service to be ready
        timeout 30 bash -c 'until curl -f http://localhost:8080/health; do sleep 1; done'
        
        # Test the endpoint
        response=$(curl -s http://localhost:8080/health)
        echo "Response: $response"
        
        # Check if response contains expected JSON
        echo "$response" | grep -q '"status":"ok"' || exit 1
        
    - name: Cleanup
      if: always()
      run: |
        docker stop integration-test || true
        docker rm integration-test || true
